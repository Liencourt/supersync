{% extends 'base.html' %}
{% load static %}

{% block title %}Contratos - Super Sync{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="page-title-box">
            <div class="page-title-right">
                <a href="#" class="btn btn-success ms-2"><i class="ti ti-download me-1"></i> Exportar</a>
            </div>
            <h4 class="page-title">Lista de Contratos</h4>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" action="{% url 'contratos:listar_contratos' %}">
                    <div class="row">
                        <div class="col-md-5 mb-3">
                            <label for="descsub" class="form-label">SubContrato / Razão Social</label>
                            <input type="text" class="form-control" id="descsub" name="descsub" 
                                   value="{{ filtros.descsub }}" placeholder="Ex: Fornecedor X">
                        </div>
                        <div class="col-md-5 mb-3">
                            <label for="desccontrato" class="form-label">Descrição Contrato</label>
                            <input type="text" class="form-control" id="desccontrato" name="desccontrato" 
                                   value="{{ filtros.desccontrato }}" placeholder="Ex: Contrato 2024">
                        </div>
                        <div class="col-md-2 mb-3 d-flex align-items-end">
                            <div class="d-grid w-100">
                                <button type="submit" class="btn btn-primary"><i class="ti ti-search me-1"></i> Buscar</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="header-title">Contratos Disponíveis <span class="badge bg-secondary rounded-pill ms-1">{{ total|default:"0" }}</span></h4>
                    
                    {% if total > 0 %}
                    <div class="d-flex align-items-center">
                        <label class="me-2 small">Mostrar:</label>
                        <select class="form-select form-select-sm" style="width: 70px;" onchange="changePerPage(this.value)">
                            <option value="10">10</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    {% endif %}
                </div>

                {% if contratos %}
                <div class="table-responsive">
                    <table class="table table-centered table-nowrap table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                {% for key in contratos.0.keys %}
                                    <th>{{ key|title }}</th>
                                {% endfor %}
                                <th style="width: 100px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for contrato in contratos %}
                            <tr>
                                {% for value in contrato.values %}
                                    <td>{{ value }}</td>
                                {% endfor %}
                                <td>
                                    <button onclick="abrirDetalhes({{ contrato.subcontrato }})" class="btn btn-sm btn-info rounded-pill" title="Detalhes">
                                        <i class="ti ti-eye"></i> Ver
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% if contratos.paginator.num_pages > 1 %}
                <div class="mt-4">
                    <ul class="pagination pagination-rounded justify-content-center mb-0">
                        {% if contratos.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ contratos.previous_page_number }}"><i class="ti ti-chevron-left"></i></a>
                        </li>
                        {% else %}
                        <li class="page-item disabled"><a class="page-link" href="#"><i class="ti ti-chevron-left"></i></a></li>
                        {% endif %}

                        <li class="page-item active"><a class="page-link" href="#">{{ contratos.number }}</a></li>

                        {% if contratos.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ contratos.next_page_number }}"><i class="ti ti-chevron-right"></i></a>
                        </li>
                        {% else %}
                        <li class="page-item disabled"><a class="page-link" href="#"><i class="ti ti-chevron-right"></i></a></li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}

                {% else %}
                    <div class="alert alert-light border text-center" role="alert">
                        <i class="ti ti-search fs-1 text-muted d-block mb-2"></i>
                        Nenhum contrato encontrado com os filtros atuais.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detalhesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Contrato</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detalhesConteudo">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Carregando...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_javascript %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    // 1. Definimos o padrão com um ID falso '0'
    // O Django vai gerar algo como: /contratos/detalhes/0/
    const urlPattern = "{% url 'contratos:detalhes_contrato' 0 %}";

    function formatarData(dataStr) {
        if (!dataStr) return '-';
        // Supondo que venha YYYY-MM-DD do BigQuery/Python
        const partes = dataStr.split('-'); 
        if(partes.length === 3) return `${partes[2]}/${partes[1]}/${partes[0]}`;
        return dataStr;
    }

    function abrirDetalhes(subcontratoId) {
        console.log("--------------------------------");
        console.log("Iniciando busca para ID:", subcontratoId);

        // 2. Substituímos o '0' pelo ID real do contrato
        // De: /contratos/detalhes/0/  -> Para: /contratos/detalhes/1722/
        const urlCompleta = urlPattern.replace('0', subcontratoId);
        
        console.log("URL Gerada:", urlCompleta); // <-- Verifique isso no console (F12) se der erro

        // Configuração do Modal
        const modalEl = document.getElementById('detalhesModal');
        const contentEl = document.getElementById('detalhesConteudo');
        
        // Spinner de Carregamento
        contentEl.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Carregando dados do contrato #${subcontratoId}...</p>
            </div>
        `;
        
        // Abre o Modal
        const myModal = new bootstrap.Modal(modalEl);
        myModal.show();

        $.ajax({
            url: urlCompleta,
            method: 'GET',
            success: function(response) {
                console.log("Dados Recebidos:", response);

                if (response.success) {
                    const info = response.info_contrato || {};
                    const fornecedores = response.fornecedores || [];
                    const produtos = response.produtos || [];

                    // 1. MONTAR CABEÇALHO (INFO CONTRATO)
                    let html = `
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card border-primary border">
                                    <div class="card-body">
                                        <h5 class="card-title text-primary">Dados do Contrato</h5>
                                        <p class="mb-1"><strong>Contrato:</strong> ${info.nomecontrato || '-'}</p>
                                        <p class="mb-1"><strong>Subcontrato:</strong> ${info.nomesubcontrato || '-'}</p>
                                        <p class="mb-1"><strong>Vigência:</strong> ${formatarData(info.dtainiciovalidade)} até ${formatarData(info.dtafimvalidade)}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-success border">
                                    <div class="card-body">
                                        <h5 class="card-title text-success">Condições Comerciais</h5>
                                        <p class="mb-1"><strong>Desconto (%):</strong> ${(info.percdesconto * 100).toFixed(2)}%</p>
                                        <p class="mb-1"><strong>Desc. Fixo (R$):</strong> ${info.vlrdescontofixo || '0,00'}</p>
                                        <p class="mb-1"><strong>ID Subcontrato:</strong> ${info.subcontrato}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // 2. MONTAR TABELA DE FORNECEDORES
                    html += `<h5 class="mt-3"><i class="ti ti-truck me-1"></i> Fornecedores Vinculados</h5>`;
                    if (fornecedores.length > 0) {
                        html += `<div class="table-responsive mb-3"><table class="table table-sm table-striped table-bordered">
                            <thead class="table-light"><tr><th>Razão Social</th><th>Fantasia</th><th>CNPJ</th></tr></thead>
                            <tbody>`;
                        
                        fornecedores.forEach(f => {
                            html += `<tr>
                                <td>${f.NOMERAZAO || '-'}</td>
                                <td>${f.FANTASIA || '-'}</td>
                                <td><code>${f.cnpj_completo || '-'}</code></td>
                            </tr>`;
                        });
                        html += `</tbody></table></div>`;
                    } else {
                        html += `<div class="alert alert-warning py-2">Nenhum fornecedor vinculado.</div>`;
                    }

                    // 3. MONTAR TABELA DE PRODUTOS
                    html += `<h5 class="mt-3"><i class="ti ti-package me-1"></i> Produtos (Amostra 10 itens)</h5>`;
                    if (produtos.length > 0) {
                        html += `<div class="table-responsive"><table class="table table-sm table-hover">
                            <thead class="table-light"><tr><th style="width:80px">Cód.</th><th>Descrição</th></tr></thead>
                            <tbody>`;
                        
                        produtos.forEach(p => {
                            html += `<tr>
                                <td><strong>${p.SEQPRODUTO}</strong></td>
                                <td>${p.DESCCOMPLETA}</td>
                            </tr>`;
                        });
                        html += `</tbody></table></div>`;
                    } else {
                        html += `<div class="alert alert-info py-2">Nenhum produto listado.</div>`;
                    }

                    // Injeta o HTML final
                    contentEl.innerHTML = html;

                } else {
                    // Caso venha success: false do backend
                    contentEl.innerHTML = `<div class="alert alert-danger">${response.erro || 'Erro desconhecido ao carregar dados.'}</div>`;
                }
            },
            
            error: function(xhr, status, error) {
                console.error("Erro Ajax:", status, error);
                console.error("Resposta:", xhr.responseText);
                
                contentEl.innerHTML = `
                    <div class="alert alert-danger text-center m-4">
                        <i class="ti ti-alert-triangle fs-1 d-block mb-2"></i>
                        <h4>Erro ao carregar detalhes</h4>
                        <p>Não foi possível encontrar o contrato na URL:</p>
                        <code class="d-block mb-3 p-2 bg-light border rounded">${urlCompleta}</code>
                        <small class="text-muted">Erro técnico: ${error} (${xhr.status})</small>
                    </div>
                `;
            }
        });
    }

    // Limpa o conteúdo ao fechar para evitar "piscar" dados antigos
    const modalDom = document.getElementById('detalhesModal');
    if (modalDom) {
        modalDom.addEventListener('hidden.bs.modal', function () {
            document.getElementById('detalhesConteudo').innerHTML = '';
        });
    }
</script>
{% endblock %}